openapi: 3.0.3
info:
  title: Alkemio Kratos Webhooks API
  description: |
    HTTP webhook gateway service that receives webhooks from external systems
    and publishes notification events to the Alkemio platform.
  version: 1.0.0
  contact:
    name: Alkemio Team

servers:
  - url: http://kratos-webhooks:8080
    description: Internal Kubernetes service

tags:
  - name: webhooks
    description: Webhook endpoints for external systems
  - name: login-backoff
    description: Login brute force protection endpoints
  - name: health
    description: Health check endpoints

paths:
  /api/v1/webhooks/kratos/verification:
    post:
      tags:
        - webhooks
      summary: Ory Kratos post-verification webhook
      description: |
        Receives webhook after successful email verification in Ory Kratos.
        Publishes a UserSignupWelcome notification event to RabbitMQ.

        **Important**: This endpoint always returns HTTP 200 to Kratos, even if
        notification processing fails. This ensures the verification flow is not blocked.
      operationId: kratosVerificationWebhook
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/KratosVerificationPayload'
            example:
              identity_id: "550e8400-e29b-41d4-a716-446655440000"
              email: "john@example.com"
              display_name: "John Doe"
              first_name: "John"
      responses:
        '200':
          description: Webhook received and processed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WebhookResponse'
              examples:
                success:
                  summary: Notification sent
                  value:
                    status: "success"
                skipped_duplicate:
                  summary: Duplicate webhook (welcome already sent)
                  value:
                    status: "skipped"
                    message: "welcome email already sent for this identity"
                skipped_missing_traits:
                  summary: Missing required traits
                  value:
                    status: "skipped"
                    message: "missing required traits: first_name"
        '503':
          description: Service unavailable (maintenance mode)
          headers:
            Retry-After:
              schema:
                type: integer
              description: Seconds until retry is recommended
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MaintenanceResponse'

  /api/v1/webhooks/kratos/login-backoff/before-login:
    post:
      tags:
        - login-backoff
      summary: Check lockout status and increment attempt counters
      description: |
        Called before each login attempt. Increments the failed attempt counter
        for the provided identifier and/or client IP, then checks whether either
        has exceeded the configured threshold.

        If locked out, returns HTTP 403 with lockout details.
        If allowed, returns HTTP 200 with current attempt counts.

        Fail-open: If Redis is unavailable or input is malformed, returns HTTP 200
        (login allowed) and logs a warning.
      operationId: loginBackoffBeforeLogin
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/BeforeLoginRequest'
            examples:
              full:
                summary: Both identifier and IP provided
                value:
                  flow_id: "550e8400-e29b-41d4-a716-446655440000"
                  identifier: "user@example.com"
                  client_ip: "192.168.1.100"
              identifier_only:
                summary: Only identifier provided
                value:
                  identifier: "user@example.com"
              ip_only:
                summary: Only client IP provided
                value:
                  flow_id: "550e8400-e29b-41d4-a716-446655440000"
                  client_ip: "192.168.1.100"
      responses:
        '200':
          description: Login attempt allowed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BeforeLoginAllowedResponse'
              example:
                allowed: true
                identifier_attempts: 3
                ip_attempts: 5
        '403':
          description: Login attempt blocked (lockout active)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BeforeLoginBlockedResponse'
              examples:
                identifier_locked:
                  summary: Locked out by identifier threshold
                  value:
                    allowed: false
                    reason: "identifier"
                    message: "Account temporarily locked due to too many failed attempts. Try again in 2 minutes."
                    retry_after_seconds: 95
                ip_locked:
                  summary: Locked out by IP threshold
                  value:
                    allowed: false
                    reason: "ip"
                    message: "Too many login attempts from this address. Try again in 2 minutes."
                    retry_after_seconds: 110
        '503':
          description: Service unavailable (maintenance mode)
          headers:
            Retry-After:
              schema:
                type: integer
              description: Seconds until retry is recommended
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MaintenanceResponse'

  /api/v1/webhooks/kratos/login-backoff/after-login:
    post:
      tags:
        - login-backoff
      summary: Reset attempt counters after successful login
      description: |
        Called by Kratos after-login webhook after successful password authentication.
        Resets the failed attempt counters for the provided identifier and client IP.

        Always returns HTTP 200 (fail-open). Errors in counter reset are logged
        but do not affect the response.
      operationId: loginBackoffAfterLogin
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AfterLoginRequest'
            example:
              identity_id: "550e8400-e29b-41d4-a716-446655440000"
              email: "user@example.com"
              client_ip: "192.168.1.100"
      responses:
        '200':
          description: Counters reset (or no action needed)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AfterLoginResponse'
              examples:
                success:
                  summary: Counters successfully reset
                  value:
                    status: "success"
                    message: "counters reset"
                skipped:
                  summary: No counters to reset (missing fields)
                  value:
                    status: "skipped"
                    message: "no identifier or IP provided"
        '503':
          description: Service unavailable (maintenance mode)
          headers:
            Retry-After:
              schema:
                type: integer
              description: Seconds until retry is recommended
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MaintenanceResponse'

  /health/live:
    get:
      tags:
        - health
      summary: Liveness probe
      description: Returns 200 if the service is running.
      operationId: healthLive
      responses:
        '200':
          description: Service is alive
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'
              example:
                status: "ok"
                timestamp: "2026-01-26T10:30:45Z"

  /health/ready:
    get:
      tags:
        - health
      summary: Readiness probe
      description: |
        Returns 200 if the service is ready to accept traffic.
        Checks connectivity to Redis and RabbitMQ.
      operationId: healthReady
      responses:
        '200':
          description: Service is ready
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ReadinessResponse'
              example:
                status: "ok"
                redis: "connected"
                rabbitmq: "connected"
                timestamp: "2026-01-26T10:30:45Z"
        '503':
          description: Service not ready
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ReadinessResponse'
              example:
                status: "unhealthy"
                redis: "disconnected"
                rabbitmq: "connected"
                timestamp: "2026-01-26T10:30:45Z"

components:
  schemas:
    KratosVerificationPayload:
      type: object
      description: Webhook payload from Ory Kratos after email verification
      required:
        - identity_id
        - email
        - display_name
        - first_name
      properties:
        identity_id:
          type: string
          format: uuid
          description: Kratos identity UUID
          example: "550e8400-e29b-41d4-a716-446655440000"
        email:
          type: string
          format: email
          description: Verified email address
          example: "john@example.com"
        display_name:
          type: string
          description: User's display name
          example: "John Doe"
        first_name:
          type: string
          description: User's first name
          example: "John"

    WebhookResponse:
      type: object
      description: Response to webhook invocation
      required:
        - status
      properties:
        status:
          type: string
          enum: [success, skipped, error]
          description: Processing status
        message:
          type: string
          description: Optional message explaining the status

    HealthResponse:
      type: object
      description: Basic health check response
      required:
        - status
        - timestamp
      properties:
        status:
          type: string
          enum: [ok, degraded, unhealthy]
        timestamp:
          type: string
          format: date-time

    ReadinessResponse:
      type: object
      description: Readiness check response with dependency status
      required:
        - status
        - redis
        - rabbitmq
        - timestamp
      properties:
        status:
          type: string
          enum: [ok, degraded, unhealthy]
        redis:
          type: string
          enum: [connected, disconnected]
        rabbitmq:
          type: string
          enum: [connected, disconnected]
        timestamp:
          type: string
          format: date-time

    BeforeLoginRequest:
      type: object
      description: |
        Payload for the before-login check. At least one of identifier or
        client_ip should be provided for meaningful protection.
      properties:
        flow_id:
          type: string
          format: uuid
          description: Kratos login flow ID (optional, used for correlation logging)
          example: "550e8400-e29b-41d4-a716-446655440000"
        identifier:
          type: string
          format: email
          description: Login identifier (email address)
          example: "user@example.com"
        client_ip:
          type: string
          description: Client IP address (IPv4 or IPv6)
          example: "192.168.1.100"

    BeforeLoginAllowedResponse:
      type: object
      description: Login attempt is allowed to proceed
      required:
        - allowed
        - identifier_attempts
        - ip_attempts
      properties:
        allowed:
          type: boolean
          enum: [true]
        identifier_attempts:
          type: integer
          minimum: 0
          description: Current failed attempt count for identifier (0 if not tracked)
        ip_attempts:
          type: integer
          minimum: 0
          description: Current failed attempt count for IP (0 if not tracked)

    BeforeLoginBlockedResponse:
      type: object
      description: Login attempt is blocked due to lockout
      required:
        - allowed
        - reason
        - message
        - retry_after_seconds
      properties:
        allowed:
          type: boolean
          enum: [false]
        reason:
          type: string
          enum: [identifier, ip]
          description: Which dimension triggered the lockout
        message:
          type: string
          description: Human-readable lockout message with remaining time
        retry_after_seconds:
          type: integer
          minimum: 0
          description: Seconds until lockout expires

    AfterLoginRequest:
      type: object
      description: Payload from Kratos after successful password authentication
      properties:
        identity_id:
          type: string
          format: uuid
          description: Kratos identity UUID
          example: "550e8400-e29b-41d4-a716-446655440000"
        email:
          type: string
          format: email
          description: Authenticated user's email (identifier to reset)
          example: "user@example.com"
        client_ip:
          type: string
          description: Client IP address to reset
          example: "192.168.1.100"

    AfterLoginResponse:
      type: object
      description: Response after processing successful login notification
      required:
        - status
      properties:
        status:
          type: string
          enum: [success, skipped]
        message:
          type: string
          description: Description of action taken

    MaintenanceResponse:
      type: object
      description: Response when service is in maintenance mode
      required:
        - status
        - message
      properties:
        status:
          type: string
          enum: [unavailable]
        message:
          type: string
          description: Maintenance message
