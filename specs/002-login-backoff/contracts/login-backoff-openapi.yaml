openapi: 3.0.3
info:
  title: Login Backoff Webhook Endpoints
  description: |
    Login brute force protection endpoints for the Alkemio Kratos Webhooks service.

    Two endpoints handle the login backoff lifecycle:
    - **before-login**: Called before each login attempt to check lockout status and increment counters.
    - **after-login**: Called after successful password authentication to reset counters.

    The before-login endpoint is designed to be called by any integration layer
    that can provide the identifier and client IP at credential submission time.

    Additionally, the kratos-webhooks includes a built-in reverse proxy that
    intercepts Kratos login POST submissions (routed via Traefik on
    `/self-service/login`). The proxy extracts identifier and client IP from
    the request body/headers, checks backoff, and returns HTTP 429 (API) or
    HTTP 303 redirect to `/login?lockout=true&retry_after=N` (browser) when blocked.

    The after-login endpoint is called by a Kratos after-login webhook hook
    configured with a Jsonnet template that extracts identity and IP information.
  version: 1.0.0

servers:
  - url: http://kratos-webhooks:8080
    description: Internal Kubernetes service

tags:
  - name: login-backoff
    description: Login brute force protection endpoints

paths:
  /api/v1/webhooks/kratos/login-backoff/before-login:
    post:
      tags:
        - login-backoff
      summary: Check lockout status and increment attempt counters
      description: |
        Called before each login attempt. Increments the failed attempt counter
        for the provided identifier and/or client IP, then checks whether either
        has exceeded the configured threshold.

        If locked out, returns HTTP 403 with lockout details.
        If allowed, returns HTTP 200 with current attempt counts.

        Fail-open: If Redis is unavailable, returns HTTP 200 (login allowed)
        and logs a warning.

        At least one of `identifier` or `client_ip` should be provided.
        If neither is present, the request is skipped (allowed) with a warning.
      operationId: loginBackoffBeforeLogin
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/BeforeLoginRequest'
            examples:
              full:
                summary: Both identifier and IP provided
                value:
                  flow_id: "550e8400-e29b-41d4-a716-446655440000"
                  identifier: "user@example.com"
                  client_ip: "192.168.1.100"
              identifier_only:
                summary: Only identifier provided
                value:
                  identifier: "user@example.com"
              ip_only:
                summary: Only client IP provided (e.g., from Kratos before-hook)
                value:
                  flow_id: "550e8400-e29b-41d4-a716-446655440000"
                  client_ip: "192.168.1.100"
      responses:
        '200':
          description: Login attempt allowed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BeforeLoginAllowedResponse'
              example:
                allowed: true
                identifier_attempts: 3
                ip_attempts: 5
        '403':
          description: Login attempt blocked (lockout active)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BeforeLoginBlockedResponse'
              examples:
                identifier_locked:
                  summary: Locked out by identifier threshold
                  value:
                    allowed: false
                    reason: "identifier"
                    message: "Account temporarily locked due to too many failed attempts. Try again in 2 minutes."
                    retry_after_seconds: 95
                ip_locked:
                  summary: Locked out by IP threshold
                  value:
                    allowed: false
                    reason: "ip"
                    message: "Too many login attempts from this address. Try again in 2 minutes."
                    retry_after_seconds: 110
        '503':
          description: Service unavailable (maintenance mode)
          headers:
            Retry-After:
              schema:
                type: integer
              description: Seconds until retry is recommended
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MaintenanceResponse'

  /api/v1/webhooks/kratos/login-backoff/after-login:
    post:
      tags:
        - login-backoff
      summary: Reset attempt counters after successful login
      description: |
        Called by Kratos after-login webhook after successful password authentication.
        Resets the failed attempt counters for the provided identifier and client IP.

        Returns HTTP 200 in normal operation (including fail-open reset errors).
        When global maintenance mode is enabled, the gateway may return HTTP 503.
      operationId: loginBackoffAfterLogin
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AfterLoginRequest'
            example:
              identity_id: "550e8400-e29b-41d4-a716-446655440000"
              email: "user@example.com"
              client_ip: "192.168.1.100"
      responses:
        '200':
          description: Counters reset (or no action needed)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AfterLoginResponse'
              examples:
                success:
                  summary: Counters successfully reset
                  value:
                    status: "success"
                    message: "counters reset"
                skipped:
                  summary: No counters to reset (missing fields)
                  value:
                    status: "skipped"
                    message: "no identifier or IP provided"
        '503':
          description: Service unavailable (maintenance mode)
          headers:
            Retry-After:
              schema:
                type: integer
              description: Seconds until retry is recommended
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MaintenanceResponse'

  /self-service/login:
    post:
      tags:
        - login-backoff
      summary: Reverse proxy for Kratos login with backoff enforcement
      description: |
        Intercepts Kratos login credential submissions. Extracts identifier
        from JSON or form-encoded body and client IP from headers. Checks
        backoff thresholds. If allowed, proxies the request to Kratos. If
        blocked, returns 429 (API) or 303 redirect (browser).

        Routed via Traefik: `/ory/kratos/public/self-service/login*` strips
        prefix and forwards to kratos-webhooks.
      operationId: loginProxy
      responses:
        '200':
          description: Proxied response from Kratos (login allowed, forwarded to Kratos)
        '303':
          description: Browser lockout redirect to `/login?lockout=true&retry_after=N`
        '429':
          description: API lockout response
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: object
                    properties:
                      code:
                        type: integer
                        enum: [429]
                      status:
                        type: string
                        enum: ["Too Many Requests"]
                      reason:
                        type: string
                        enum: [identifier, ip]
                      message:
                        type: string
    get:
      tags:
        - login-backoff
      summary: Proxy GET requests to Kratos (flow creation)
      description: |
        GET requests (e.g., `/self-service/login/browser`, `/self-service/login/api`)
        are proxied directly to Kratos without backoff interception.
      operationId: loginProxyGet
      responses:
        '200':
          description: Proxied response from Kratos
        '303':
          description: Kratos redirect (browser flow creation)

components:
  schemas:
    BeforeLoginRequest:
      type: object
      description: |
        Payload for the before-login check. At least one of identifier or
        client_ip should be provided for meaningful protection.
      properties:
        flow_id:
          type: string
          format: uuid
          description: Kratos login flow ID (optional, used for correlation logging)
          example: "550e8400-e29b-41d4-a716-446655440000"
        identifier:
          type: string
          format: email
          description: Login identifier (email address)
          example: "user@example.com"
        client_ip:
          type: string
          description: Client IP address (IPv4 or IPv6)
          example: "192.168.1.100"

    BeforeLoginAllowedResponse:
      type: object
      description: Login attempt is allowed to proceed
      required:
        - allowed
        - identifier_attempts
        - ip_attempts
      properties:
        allowed:
          type: boolean
          enum: [true]
        identifier_attempts:
          type: integer
          minimum: 0
          description: Current failed attempt count for identifier (0 if not tracked)
        ip_attempts:
          type: integer
          minimum: 0
          description: Current failed attempt count for IP (0 if not tracked)

    BeforeLoginBlockedResponse:
      type: object
      description: Login attempt is blocked due to lockout
      required:
        - allowed
        - reason
        - message
        - retry_after_seconds
      properties:
        allowed:
          type: boolean
          enum: [false]
        reason:
          type: string
          enum: [identifier, ip]
          description: Which dimension triggered the lockout
        message:
          type: string
          description: Human-readable lockout message with remaining time
        retry_after_seconds:
          type: integer
          minimum: 0
          description: Seconds until lockout expires

    AfterLoginRequest:
      type: object
      description: Payload from Kratos after successful password authentication
      properties:
        identity_id:
          type: string
          format: uuid
          description: Kratos identity UUID
          example: "550e8400-e29b-41d4-a716-446655440000"
        email:
          type: string
          format: email
          description: Authenticated user's email (identifier to reset)
          example: "user@example.com"
        client_ip:
          type: string
          description: Client IP address to reset
          example: "192.168.1.100"

    AfterLoginResponse:
      type: object
      description: Response after processing successful login notification
      required:
        - status
      properties:
        status:
          type: string
          enum: [success, skipped]
        message:
          type: string
          description: Description of action taken

    MaintenanceResponse:
      type: object
      description: Response when service is in maintenance mode
      required:
        - status
        - message
      properties:
        status:
          type: string
          enum: [unavailable]
        message:
          type: string
